<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<meta http-equiv="Content-Security-Policy" content="default-src * data:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
	<script src="components/loader.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.8/angular-sanitize.min.js"></script>
	<script src="js/angular-locale_ja-jp.js"></script>
	<link rel="stylesheet" href="components/loader.css">
	<link rel="stylesheet" href="css/base.css">
	<link rel="stylesheet" href="css/style.css">
	<script>



var app = ons.bootstrap('myApp', [ 'ngSanitize' ]);
const MENUS = [
	{ page: 'shop.html',         name: 'Shop Information',      jpname: '会社情報',   background: 'Unknown-1.jpeg', },
	// { page: 'history.html',      name: 'History',               jpname: '歴史',       background: 'A-1006.jpg',     },
	{ page: 'market_list.html',  name: 'Precious Metal Market', jpname: '貴金属相場', background: 'IMG_2012.JPG',   },
	{ page: 'news_list.html',    name: 'Good News',             jpname: '行事予定',   background: 'IMG_0606.JPG',   },
	{ page: 'product_list.html', name: 'New Arrival',           jpname: '商品',       background: 'Unknown.jpeg',   },
	{ page: 'signup.html',       name: 'Be A Member',           jpname: '会員登録',           background: 'w-102.jpg',      },
];
const MENUS_LOGGEDIN = [
	{ page: 'shop.html',         name: 'Shop Information',      jpname: '会社情報',   background: 'Unknown-1.jpeg', },
	// { page: 'history.html',      name: 'History',               jpname: '歴史',       background: 'A-1006.jpg',     },
	{ page: 'market_list.html',  name: 'Precious Metal Market', jpname: '貴金属相場', background: 'IMG_2012.JPG',   },
	{ page: 'news_list.html',    name: 'Good News',             jpname: '行事予定',   background: 'IMG_0606.JPG',   },
	{ page: 'product_list.html', name: 'New Arrival',           jpname: '商品',       background: 'Unknown.jpeg',   },
	{ page: 'members.html',      name: 'Members Page',          jpname: '会員専用コンテンツ', background: 'images.jpeg',    },
	{ page: 'qr.html',           name: 'QR Code Reader',        jpname: 'QRコードリーダー', background: 'images.jpeg',    },
];

const MORE_MENUS = [
	{ member_only: 0, page: 'shop.html', name: 'Shop Information', jpname: '会社情報' },
];

const PRIVILEGE = '<h3>ポイント</h3>' +
'<p>'+
'自動集計により、お買い上・お修理、又、行事にご参加の場合、ポイントを付加し、種々のプレゼントを差し上げます。' +
'</p>' +
'<h3>ディスカウント</h3>' +
'<p>' +
'製品お買い上げ・お修理等に対し、10%ディスカウント致します。' +
'</p>'+
'<h3>バースデープレゼント</h3>' +
'<p>' +
'お誕生日に持ち込まれたジュエリーリングのサイズ直し又は新仕上げ又はパールネックレス等の糸かえは、一点につき、無料にてさせていただきます。' +
'</p>';

const POINT_DESCRIPTION = '<ul>'+
'	<li>お買い上げ又はお修理代金 1万円につき1ポイント</li>'+
'	<li>ALEX主催の行事にご参加いただくと(原則¥5,000の会費に対し)1ポイント</li>'+
'	<li>ご友人のご紹介(会員登録)をいただければ2ポイント<br>(お買い上げ又はお修理いただいた場合に限ります)</li>'+
'</ul>'+
'<p>'+
'※ポイントは3年間有効です。<br>'+
'ポイント交換はお客様よりお申し出下さい。'+
'</p>'+
'<dl>'+
'	<dt>15ポイント</dt><dd>金券5,000円、又は ALEX商品券 10,000円分</dd>'+
'	<dt>25ポイント</dt><dd>1人様お食事券プレゼント(ディナータイム)</dd>'+
'	<dt>40ポイント</dt><dd>ペアお食事券プレゼント(ディナータイム)</dd>'+
'</dl>';

const SHOP_INFO = {
	e_name:  'ALEX CO. Ltd',
	name:    '株式会社アレックス ',
	zip:     '〒604-8062',
	address: '京都府京都市中京区蛸薬師通麩屋町東入ル蛸屋町153',
	e_zip:     '〒604-8062',
	e_address: 'TAKOYACHO153 NAKAGYO-KU KYOTO JAPAN',
	web:     'http://www.j-alex.com/',
	tel:     '075-221-7777',
	telnum:  '0752217777',
	telmarket: '075-221-1059',
	telmarketnum: '0752211059',
	fax:     '075-211-0889',
	lat:     '35.006096',
	lng:     '135.7636673',
	img:     'images/shop.jpg',
	mail:    'alex@j-alex.com',
	open:    '10:00 〜 18:00',
	close:   '<p>日曜・祝日<br>(ご予約により時間外も対応させていただきます)</p>',
	description: '宝石、貴金属製品&nbsp;輸入・製造・小売業<br>創業 1990年2月22日(平成元年2月22日)',
};

const STAFFS = [
	{ name: 'JUNJI WADA', line: 'example', telnum: '0000000000', },
	{ name: 'JUNJI WADA', line: 'example', telnum: '0000000000', },
	{ name: 'JUNJI WADA', line: 'example', telnum: '0000000000', },
	// { name: '', id: '', tel: '', telnum: '', }
];

const BASE_URL      = "http://ik1-324-22351.vs.sakura.ne.jp/alex/";
const AJAX_BASE_URL = BASE_URL + "rest/app/";

const AJAX_SIGNUP    = AJAX_BASE_URL + "signup.json";    // サインアップ
const AJAX_LOGIN     = AJAX_BASE_URL + "login.json";     // ログイン
const AJAX_LOGGEDIN  = AJAX_BASE_URL + "loggedin.json";   // ログインのチェック
const AJAX_CHANGE_PW = AJAX_BASE_URL + "change_pw.json"; // パスワード変更
const AJAX_MARKET    = AJAX_BASE_URL + "market.json";    // 貴金属相場
const AJAX_NEWS      = AJAX_BASE_URL + "news.json";      // 新着情報
const AJAX_PRODUCT   = AJAX_BASE_URL + "product.json";   // 商品情報
const AJAX_LIKE      = AJAX_BASE_URL + "like.json";      // 「いいね」ボタン
const AJAX_QR        = AJAX_BASE_URL + "qr.json";      // QRコード

const IMG_DIR        = BASE_URL + "images";

const STORAGE_USER_DATA_KEY = "user_data";
const STORAGE_ID            = "user_id";
const STORAGE_ONETIME_KEY   = "onetime_key";
const STORAGE_POINT         = "point";
const STORAGE_CREATED_AT    = "created_at";

app.factory('SharedData', function() {
	var sharedData = {};
	sharedData.data = {};
	sharedData.userData = {};
	
	var userData = {};
	
	// データを設定
	sharedData.set = function(data)
	{
		sharedData.data = data;
	};
	
	sharedData.get = function()
	{
		return sharedData.data;
	};
	
	sharedData.setUser = function(data)
	{
		sharedData.userData.name = data.name;
		sharedData.userData.email = data.email;
	};
	sharedData.getUser = function()
	{
		return sharedData.userData;
	};
	return sharedData;
});

app.filter('mysql_date', ['$filter', function($filter)
{
	return function (value, fraction)
	{
		value = new Date(value.replace(/-/g, '/'));
		return $filter('date')(value, fraction);
	}
}]);

/**
 * ====================
 * TopController
 * ====================
 */
app.controller('TopController', function($scope, $http, SharedData)
{
	$scope.loggedin = isLoggedIn();

	if ($scope.loggedin)
	{
		$scope.menuMain = MENUS_LOGGEDIN;
	}
	else
	{
		$scope.menuMain = MENUS;
	}
	var menu_sub = MENUS.slice(0);
	menu_sub.push( menu_sub.shift() );
	$scope.menuSub  = menu_sub;

	ons.ready(function()
	{
		const DELAY = 100;
		const STOP_DURATION = 300;
		var timer;
		const SCROLL_TIMEOUT = 50;
		const LI_HEIGHT = 40;
		const LI_HALF   = LI_HEIGHT/2;
		const LI_COUNT  = 7;
		const UL_HEIGHT = LI_HEIGHT * LI_COUNT;
		
		$('#main_image').height($('#main_content').height() - LI_HEIGHT*7);
		$('#main_image ul').height($('#main_image') * LI_COUNT);
		$('#main_image ul li').height($('#main_image').height());
		
		var IMAGE_HEIGHT = $('#main_image').height();
		var PER_FOR_IMAGE = IMAGE_HEIGHT/LI_HEIGHT;

		$scope.slideSubMenu = function(e)
		{
			slideY = $('#menu_sub').scrollTop() + $(e.target).offset().top - $('#menu_sub').offset().top + LI_HEIGHT;

			if (slideY > UL_HEIGHT*2 + LI_HEIGHT)
			{
				slideY = slideY - UL_HEIGHT;
			}
			else if (slideY < UL_HEIGHT - LI_HEIGHT)
			{
				slideY = slideY + UL_HEIGHT;
			}

			$('#menu_sub').scrollTop(slideY);
			$('#menu_main').scrollTop(slideY);
			$('#main_image').scrollTop(slideY*PER_FOR_IMAGE);

			$('#menu_sub').stop(false, true).animate({scrollTop: slideY},200);
			$('#menu_main').stop(false, true).animate({scrollTop: slideY},200);
			$('#main_image').stop(false, true).animate({scrollTop: slideY*PER_FOR_IMAGE},200);

		};
		var touchY = 0;
		var slideY = 0;

		$('#menu_sub').on(
		{
			/* フリック開始時 */
			'touchstart': function(e)
			{
				touchY = event.changedTouches[0].pageY;
				slideY = $('#menu_sub').scrollTop();
			},
			/* フリック中 */
			'touchmove': function(e)
			{
				e.preventDefault();
				slideY = slideY + (touchY - event.changedTouches[0].pageY );
				touchY = event.changedTouches[0].pageY;

				if (slideY > UL_HEIGHT*2 + LI_HEIGHT)
				{
					slideY = slideY - UL_HEIGHT;
				}
				else if (slideY < UL_HEIGHT - LI_HEIGHT)
				{
					slideY = slideY + UL_HEIGHT;
				}

				$('#menu_sub').scrollTop(slideY);

				$('#menu_main').scrollTop(slideY);
				$('#main_image').scrollTop(slideY*PER_FOR_IMAGE);

			},
			/* フリック終了 */
			'touchend': function(e)
			{
				setTimeout(function ()
				{
					// var sc_top = $('#menu_sub').scrollTop();
					var sc_top = slideY;
					var ssc = sc_top%LI_HEIGHT;
					var sc;
					if (ssc > LI_HALF)
					{
						sc = sc_top + (LI_HEIGHT - ssc);
					}
					else
					{
						sc = sc_top - ssc;
					}
					$('#menu_sub').stop(false, true).animate({scrollTop: sc}, STOP_DURATION);
					$('#menu_main').stop(false, true).animate({scrollTop: sc}, STOP_DURATION);
					$('#main_image').stop(false, true).animate({scrollTop: sc*PER_FOR_IMAGE}, STOP_DURATION);
				}, 50);
			},
			'scroll': function(e)
			{
				/*
				if ($('#menu_sub').scrollTop() > UL_HEIGHT*2)
				{
					var slideY = $('#menu_sub').scrollTop() - UL_HEIGHT;
					$('#menu_main').scrollTop(slideY);
					$('#menu_sub').scrollTop(slideY);
				}
				else if ($('#menu_sub').scrollTop() < UL_HEIGHT)
				{
					var slideY = $('#menu_sub').scrollTop() + UL_HEIGHT;
					$('#menu_main').scrollTop(slideY);
					$('#menu_sub').scrollTop(slideY);
				}
				*/
			}
		});

		// init
		$('#menu_main').scrollTop(UL_HEIGHT);
		$('#menu_sub').scrollTop(UL_HEIGHT);
	});
});

/**
 * ====================
 * ShopController
 * ====================
 */
app.controller('ShopController', function($scope, $http)
{
	$scope.shop_info = SHOP_INFO;
	$scope.desc      = SHOP_INFO.description;
	$scope.staffs    = STAFFS;
});

/**
 * ====================
 * NewsList
 * ====================
 */
app.controller('NewsListController', function($scope, $http, SharedData)
{
	$scope.dataList = [];
	$scope.shop_info = SHOP_INFO;
	var loading = false;
	var all_data_loaded = false;

	$scope.showDetailPage = function(data)
	{
		SharedData.set(data);
		navi.pushPage('news.html');
	};

	function readItems()
	{
		if (loading || all_data_loaded) return;
		
		$('#list_end .loading').show();
		$('#list_end .load_more').hide();
		var data = {};
		if ($scope.dataList.length > 0)
		{
			var last_element = $scope.dataList[$scope.dataList.length -1];
			data = {
				created_at: last_element.created_at,
				id:         last_element.id,
			};
		}

		loading = true;
		$.post(AJAX_NEWS, data)
		.done(function (response)
		{
			console.log(response);
			if (response == 'nomore')
			{
				all_data_loaded = true;
				$('#list_end').empty();
				$('#list_end').text('これ以上データはありません');
				return;
				
			}
			for (key in response)
			{
				$scope.dataList.push(response[key]);
			}
			$scope.$apply();
		})
		.fail(function (qxhr, status, error)
		{
		})
		.always(function ()
		{
			loading = false;
			$('#list_end .loading').hide();
			$('#list_end .load_more').show();
		});
	}

	ons.ready(function()
	{
		$("#newsList").on("touchmove", function()
		{
			if ( ($("#newsList").height() - $("#list_end").offset().top) > 0)
			{
				readItems();
			}
		});
	});

	readItems();
});

/**
 * ====================
 * News
 * ====================
 */
app.controller('NewsController', function($scope, SharedData)
{
	$scope.shop_info = SHOP_INFO;
	$scope.data = SharedData.get();
});

/**
 * ====================
 * ProductList
 * ====================
 */
app.controller('ProductListController', function($scope, $http, SharedData)
{
	$scope.dataList = [];
	$scope.BASE_URL = BASE_URL;
	var loading = false;
	var all_data_loaded = false;

	$scope.showDetailPage = function(data)
	{
		SharedData.set(data);
		navi.pushPage('product.html');
	};

	function readItems()
	{
		if (loading || all_data_loaded) return;
		
		$('#list_end .loading').show();
		$('#list_end .load_more').hide();
		var data = {};
		if ($scope.dataList.length > 0)
		{
			var last_element = $scope.dataList[$scope.dataList.length -1];
			data = {
				created_at: last_element.created_at,
				id:         last_element.id,
			};
		}

		loading = true;
		$.post(AJAX_PRODUCT, data)
		.done(function (response)
		{
			if (response == 'nomore')
			{
				all_data_loaded = true;
				$('#list_end').empty();
				$('#list_end').text('これ以上データはありません');
				return;
				
			}
			for (key in response)
			{
				$scope.dataList.push(response[key]);
			}
			$scope.$apply();
		})
		.fail(function (qxhr, status, error)
		{
		})
		.always(function ()
		{
			loading = false;
			$('#list_end .loading').hide();
			$('#list_end .load_more').show();
		});
	}


	ons.ready(function()
	{
		$("#productList").on("touchmove", function()
		{
			if ( ($("#productList").height() - $("#list_end").offset().top) > 0)
			{
				readItems();
			}
		});
	});
	
	readItems();
});

/**
 * ====================
 * Product
 * ====================
 */
app.controller('ProductController', function($scope, SharedData) {
	$scope.data = SharedData.get();
	$scope.BASE_URL = BASE_URL;
	$scope.shop_info = SHOP_INFO;
	
	$scope.loggedin = isLoggedIn();
	
	$scope.like = function(id)
	{
		$scope.modal.show();
		if (!$scope.loggedin)
		{
			ons.notification.alert({
				title: 'いいね',
				message: 'いいねをするにはログインが必要です',
			});
			return;
		}
		
		console.log($scope.loggedin.onetime_key);
		$.post(AJAX_LIKE, {
			product_id : id,
			id         : $scope.loggedin.id,
			onetime_key: $scope.loggedin.onetime_key,
		})
		.done(function (response)
		{
			console.log(response);
			if (typeof response == 'undefined')
			{
				ons.notification.alert({
					title: 'いいね',
					message: 'ネットワークエラー(もう一度お願いします)',
				});
				return;
			}
			else if (response == 'liked')
			{
				// TODO modal
				ons.notification.alert({
					title: 'いいね',
					message: '既にいいねしている商品です',
				});
				return;
				
			}
			else
			{
				$scope.data.like = parseInt(response);
					ons.notification.alert({
					title: 'いいね',
					message: 'いいねしました。ありがとうございます。',
				});
			}
			$scope.$apply();
		})
		.fail(function (qxhr, status, error)
		{
			console.log('like fail');
		})
		.always(function ()
		{
			$scope.modal.hide();
		});
	};
});


/**
 * ====================
 * MarketList
 * ====================
 */
app.controller('MarketListController', function($scope, $http, SharedData)
{
	$scope.shop_info = SHOP_INFO;
	$scope.dataList = [];
	
	var loading = false;
	var all_data_loaded = false;


	$scope.showDetailPage = function(data)
	{
		SharedData.set(data);
		navi.pushPage('market.html');
	};

	function readItems()
	{
		if (loading || all_data_loaded) return;
		
		$('#list_end .loading').show();
		$('#list_end .load_more').hide();
		var data = {};
		if ($scope.dataList.length > 0)
		{
			var last_element = $scope.dataList[$scope.dataList.length -1];
			data = {
				created_at: last_element.created_at,
				id:         last_element.id,
			};
		}

		loading = true;
		$.post(AJAX_MARKET, data)
		.done(function (response)
		{
			console.log(response);
			if (response == 'nomore')
			{
				all_data_loaded = true;
				$('#list_end').empty();
				$('#list_end').text('これ以上データはありません');
				return;
				
			}
			for (key in response)
			{
				$scope.dataList.push(response[key]);
			}
			$scope.$apply();
		})
		.fail(function (qxhr, status, error)
		{
		})
		.always(function ()
		{
			loading = false;
			$('#list_end .loading').hide();
			$('#list_end .load_more').show();
		});
	}


	ons.ready(function()
	{
		$("#marketList").on("touchmove", function()
		{
			if ( ($("#marketList").height() - $("#list_end").offset().top) > 0)
			{
				readItems();
			}
		});
	});
	

	readItems();
});

/**
 * ====================
 * Market
 * ====================
 */
app.controller('MarketController', function($scope, SharedData)
{
	$scope.data = SharedData.get();
});


/**
 * ====================
 * History
 * ====================
 */
app.controller('HistoryController', function($scope, SharedData)
{
});

/**
 * ====================
 * Signup
 * ====================
 */
app.controller('SignupController', function($scope, $http, SharedData)
{
	var userData = getUserData();
	console.log(userData);
	if (userData)
	{
		this.userData = userData;
	}

	$scope.doSignUp = function (data)
	{
		// local storage に
		localStorage.setItem(STORAGE_USER_DATA_KEY, JSON.stringify(data.userData));

		SharedData.set({
			password: data.password,
			userData: data.userData,
		});
		// password

		navi.pushPage('signup_confirm.html');
	};
});

/**
 * ====================
 * SignupConfirm
 * ====================
 */
app.controller('SignupConfirmController', function($scope, $http, SharedData)
{
	$scope.data = SharedData.get();
	
	$scope.doSignUp = function()
	{
		modal.show();
		$.post(AJAX_SIGNUP, $scope.data)
		.done(function (response)
		{
			localStorage.setItem(STORAGE_ID,          response.id);
			localStorage.setItem(STORAGE_ONETIME_KEY, response.onetime_key);
			localStorage.setItem(STORAGE_POINT,       response.point);
			localStorage.setItem(STORAGE_CREATED_AT,  response.created_at);
			ons.notification.alert({
				title: 'サインアップ',
				messageHTML: "サインアップしました<br>あなたの会員番号は  " + response.id + "番です<br>詳細・ポイントは右上の「MyCard」よりご確認いただけます",
			});
			navi.resetToPage('top.html');
		})
		.fail(function (qxhr, status, error)
		{
			console.log(qxhr);
			console.log(error);	
		})
		.always(function ()
		{
			modal.hide();
		});
	};
});

/**
 * ====================
 * MyPage
 * ====================
 */
app.controller('MypageController', ['$scope', '$http', 'SharedData' , function($scope, $http, SharedData)
{
	$scope.loggedin = isLoggedIn();
	
	if (!$scope.loggedin)
	{
		navi.popPage();
	}

	var userData = JSON.parse(localStorage.getItem(STORAGE_USER_DATA_KEY));
	if (userData)
	{
		$scope.userData  = userData;
		$scope.id        = localStorage.getItem(STORAGE_ID);
		$scope.point     = localStorage.getItem(STORAGE_POINT);
		// $scope.qrcode         = true;
	}

	ons.ready(function()
	{
		$.post(AJAX_LOGGEDIN, {
			id         : $scope.loggedin.id,
			onetime_key: $scope.loggedin.onetime_key,
		})
		.done(function (response)
		{
			if (typeof response == 'undefined')
			{
				logOut();
				navi.popPage();
				return;
			}
			else
			{
				localStorage.setItem(STORAGE_ID,          response.id);
				localStorage.setItem(STORAGE_ONETIME_KEY, response.onetime_key);
				localStorage.setItem(STORAGE_POINT,       response.point);
				localStorage.setItem(STORAGE_CREATED_AT,  response.created_at);
				
				// ポイント等を更新する
				$scope.id    = localStorage.getItem(STORAGE_ID);
				$scope.point = localStorage.getItem(STORAGE_POINT);
				$scope.$apply();
			}
		})
		.fail(function (qxhr, status, error)
		{
			// fail は何もしない
			// 明示的に undefined が帰って来た時のみ logOut する
		})
		.always(function ()
		{
			// $scope.modal.hide();
		});
	});
	
	$scope.logout = function()
	{
		logOut();
		navi.resetToPage('top.html');
	}
}]);

/**
 * ====================
 * MyCard
 * ====================
 */
app.controller('MembersController', function($scope, $http, SharedData)
{
	var userData = JSON.parse(localStorage.getItem(STORAGE_USER_DATA_KEY));
	if (userData)
	{
		$scope.userData       = userData;
		$scope.userData.id    = localStorage.getItem(STORAGE_ID);
		$scope.userData.point = localStorage.getItem(STORAGE_POINT);
	}
});


/**
 * ====================
 * LoginController
 * ====================
 */
app.controller('LoginController', function($scope, $http, SharedData)
{
	$scope.privilege = PRIVILEGE;
	$scope.point_description = POINT_DESCRIPTION;
	
	var userId = localStorage.getItem(STORAGE_ID);
	if (userId)
	{
		this.id = userId;
	}

	$scope.doLogin = function (data)
	{
		var parameter = {
			id      : data.id,
			password: data.password,
		};

		$scope.modal.show();
		$.post(AJAX_LOGIN, parameter)
		.done(function (response)
		{
			if (response)
			{
				localStorage.setItem(STORAGE_ID,          response.id);
				localStorage.setItem(STORAGE_ONETIME_KEY, response.onetime_key);
				localStorage.setItem(STORAGE_POINT,       response.point);
				localStorage.setItem(STORAGE_CREATED_AT,  response.created_at);
				navi.resetToPage('top.html');
			}
			else
			{
				ons.notification.alert({
					title: 'ログイン失敗',
					message: "ログインできませんでした\n会員番号もしくはパスワードが違います",
				});
			}
		})
		.fail(function (qxhr, status, error)
		{
			ons.notification.alert({
				title: 'ログイン失敗',
				message: "ログインできませんでした\nネットワーク環境のいい場所でもう一度やり直してください。",
			});
			console.log(qxhr);
			console.log(error);	
		})
		.always(function ()
		{
			$scope.modal.hide();
		});
	};
});


/* ====================
 * 会員専用コンテンツ
 * ==================== */
app.controller('QrController', function($scope, $http, SharedData)
{
	$scope.loggedin = isLoggedIn();
	
	$scope.scan = function ()
	{
		plugins.barcodeScanner.scan(function(result)
		{
			
			var parameter = {
				id      : $scope.loggedin.id,
				onetime_key: $scope.loggedin.onetime_key,
				text    : result.text,
			};
			$.post(AJAX_QR, parameter)
			.done(function (response)
			{
				if (typeof response == 'undefined')
				{
					ons.notification.alert({
						title: 'QRコード',
						message: 'ネットワークエラー(もう一度お願いします)',
					});
					return;
				}
				else
				{
					ons.notification.alert({
						title: 'QRコード',
						message: '情報の送信を完了しました',
					});
					return;
				}
			})
			.fail(function (qxhr, status, error)
			{
				ons.notification.alert({
					title: 'QRコード',
						messageHTML: "送信出来ませんでした。<br>ネットワーク環境のいい場所でもう一度やり直してください。",
				});	
			})
			.always(function ()
			{
				// $scope.modal.hide();
			});
		});
	}
});

var isJson = function(arg){
    arg = (typeof(arg) == "function") ? arg() : arg;
    if(typeof(arg) != "string"){return false;}
    try{arg = (!JSON) ? eval("(" + arg + ")") : JSON.parse(arg);return true;}catch(e){return false;}
}

var getUserData = function()
{
	console.log('getUserData');
	var store = localStorage.getItem(STORAGE_USER_DATA_KEY);
	if (store && isJson(store))
	{
		var userData = JSON.parse(store);
		if (userData)
		{
			return userData;
		}
	}
	
	return false;
}

var isLoggedIn = function ()
{
	var id          = localStorage.getItem(STORAGE_ID);
	var onetime_key = localStorage.getItem(STORAGE_ONETIME_KEY);
	if (onetime_key) {
		return {
			id         : id,
			onetime_key: onetime_key
		};
	} else {
		return false;
	}
}

var logOut = function ()
{
	localStorage.setItem(STORAGE_ONETIME_KEY, '');
}



	</script>
</head>

<body>
	<div ons-loading-placeholder="start.html">
		  アプリケーションの読み込みを行っています...
	</div>
	<ons-template id="start.html">

	<ons-navigator page="top.html"  animation="slide" var="navi">
	</ons-navigator>
	</ons-template>
</body>
</html>
